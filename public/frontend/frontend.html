<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>會員管理系統</title>
  <style>
    table, th, td {
      border: 1px solid gray;
      border-collapse: collapse;
      padding: 8px;
    }
    input, select {
      margin: 4px;
    }
    .edit-mode {
      background-color: #fff4cc;
    }
  </style>
</head>
<body>
  <h1>會員列表</h1>

  <table id="memberTable">
    <thead>
      <tr>
        <th>學號</th>
        <th>姓名</th>
        <th>角色</th>
        <th>系所</th>
        <th>年級</th>
        <th>電話</th>
        <th>Email</th>
        <th>入社日期</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2 id="formTitle">新增會員</h2>
  <form id="memberForm">
    <input type="hidden" id="edit_mode" value="">
    <input type="text" id="student_id" placeholder="學號" required>
    <input type="text" id="name" placeholder="姓名" required>
    <input type="text" id="role" placeholder="角色 (社員/幹部/社長)">
    <input type="text" id="department" placeholder="系所">
    <select id="grade">
      <option value="">請選擇年級</option>
      <option value="一">一</option>
      <option value="二">二</option>
      <option value="三">三</option>
      <option value="四">四</option>
    </select>
    <input type="text" id="phone" placeholder="電話">
    <input type="email" id="email" placeholder="Email">
    <input type="date" id="join_date" required>
    <button type="submit">送出</button>
    <button type="button" onclick="resetForm()">清除</button>
  </form>

  <script>
    const api = 'http://localhost:3001/members';

    async function loadMembers() {
      const res = await fetch(api);
      const members = await res.json();

      const tbody = document.querySelector('#memberTable tbody');
      tbody.innerHTML = '';

      members.forEach(member => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${member.student_id}</td>
          <td>${member.name}</td>
          <td>${member.role || ''}</td>
          <td>${member.department || ''}</td>
          <td>${member.grade || ''}</td>
          <td>${member.phone || ''}</td>
          <td>${member.email || ''}</td>
          <td>${member.join_date}</td>
          <td>
            <button onclick="editMember('${member.student_id}')">編輯</button>
            <button onclick="deleteMember('${member.student_id}')">刪除</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function deleteMember(student_id) {
      if (confirm('確定要刪除這位會員嗎？')) {
        await fetch(`${api}/${student_id}`, { method: 'DELETE' });
        loadMembers();
        resetForm();
      }
    }

    async function editMember(student_id) {
      const res = await fetch(`${api}/${student_id}`);
      const member = await res.json();

      document.getElementById('formTitle').textContent = '編輯會員';
      document.getElementById('edit_mode').value = 'true';
      document.getElementById('student_id').value = member.student_id;
      document.getElementById('student_id').readOnly = true;
      document.getElementById('name').value = member.name;
      document.getElementById('role').value = member.role || '';
      document.getElementById('department').value = member.department || '';
      document.getElementById('grade').value = member.grade || '';
      document.getElementById('phone').value = member.phone || '';
      document.getElementById('email').value = member.email || '';
      document.getElementById('join_date').value = member.join_date;
    }

    document.getElementById('memberForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const editMode = document.getElementById('edit_mode').value;
      const student_id = document.getElementById('student_id').value;

      const data = {
        student_id,
        name: document.getElementById('name').value,
        role: document.getElementById('role').value || '社員',
        department: document.getElementById('department').value,
        grade: document.getElementById('grade').value,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        join_date: document.getElementById('join_date').value
      };

      let res;
      if (editMode) {
        // 更新會員
        res = await fetch(`${api}/${student_id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
      } else {
        // 新增會員
        res = await fetch(api, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
      }

      if (res.ok) {
        alert(editMode ? '會員更新成功！' : '新增成功！');
        resetForm();
        loadMembers();
      } else {
        alert('操作失敗，請檢查輸入資料。');
      }
    });

    function resetForm() {
      document.getElementById('formTitle').textContent = '新增會員';
      document.getElementById('edit_mode').value = '';
      document.getElementById('memberForm').reset();
      document.getElementById('student_id').readOnly = false;
    }

    loadMembers();
  </script>
</body>
</html>
